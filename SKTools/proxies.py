from SKTools import altdiv

raw_proxy_list = '''54.39.250.97:3129
35.233.136.146:3128
167.99.54.39:8888
34.253.177.131:3128
14.207.124.3:8080
51.79.45.60:3129
136.243.47.220:3128
35.223.35.156:3128
62.75.216.56:3128
47.88.7.115:3129
59.124.224.180:3128
103.17.181.19:9999
193.232.150.42:3128
52.187.38.95:3128
160.16.60.65:60088
200.73.128.45:3128
200.10.96.197:3128
82.165.244.174:3128
197.81.195.28:3128
167.71.199.231:3128
64.235.204.107:8080
178.128.151.15:3128
143.93.66.208:3128
104.41.46.166:80
159.203.19.110:3128
95.217.130.87:3128
3.121.121.43:3128
138.68.68.72:3128
18.221.76.31:3128
1.234.44.23:9999
168.138.223.90:8888
88.150.236.115:3128
1.234.44.25:9999
139.99.104.240:8888
1.234.44.26:9999
178.63.41.235:9999
173.254.242.252:8888
122.50.5.148:10000
52.229.121.218:3128
104.154.143.77:3128
103.103.71.163:3128
36.90.164.145:8080
93.93.184.173:3128
37.18.79.41:3128
103.46.225.67:3128
113.196.140.162:8888
162.251.61.196:3128
51.158.186.255:8811
194.87.98.183:5836
183.111.227.113:9999
118.69.19.161:9999
206.189.40.132:8080
213.120.213.242:8081
191.239.251.48:80
54.37.103.99:3128
200.73.129.173:80
159.203.78.148:8888
51.89.227.85:9999
45.32.110.119:80
45.77.157.28:8080
79.106.97.66:8080
161.35.68.137:3128
213.32.21.9:8080
207.148.118.235:8080
167.172.254.176:8080
104.248.11.7:8080
200.52.141.162:53281
181.118.167.104:80
144.217.101.242:3129
159.203.17.5:3128
81.22.255.139:31282
18.163.104.217:3128
185.193.113.52:31282
172.245.9.10:31282
107.150.50.126:31282
192.227.166.27:31282
134.209.156.159:8080
79.137.44.85:3129
162.250.190.92:31282
69.30.214.202:31282
201.30.147.177:8080
82.200.233.4:3128
200.255.122.170:8080
109.230.199.120:31282
185.58.225.81:31282
45.124.64.163:31282
186.46.128.90:56942
185.4.132.123:31282
27.100.36.50:31282
216.189.157.167:31282
185.22.174.178:31282
68.183.57.199:3128
139.180.128.249:31282
210.16.120.93:31282
51.91.254.196:31282
37.10.71.217:31282
45.236.88.42:8880
185.158.249.102:31282
103.221.254.44:56471
80.51.31.201:8080
45.12.110.174:31282
74.91.30.106:31282
69.30.224.166:31282
195.231.65.251:31282
45.124.64.118:31282
51.68.213.212:31282
188.165.141.114:3129
198.245.55.236:31282
104.128.228.77:31282
144.76.214.152:1080
124.41.240.43:49040
185.112.157.93:31282
66.55.64.18:31282
198.23.135.211:31282
103.28.121.58:3128
178.72.74.40:35242
85.238.98.160:34449
136.243.92.25:1080
61.90.55.180:8080
195.158.109.248:50330
27.68.135.14:30199
125.27.251.24:36048
197.189.228.59:36654
147.91.111.133:37979
36.80.14.160:8080
192.41.71.204:3128
88.99.10.251:1080
5.2.164.205:52592
188.40.183.189:1080
178.33.150.97:3128
75.150.251.146:3128
185.63.46.205:57100
103.21.163.81:6666
191.5.0.79:53281
177.73.188.110:54459
103.81.114.182:53281
103.102.13.52:3129
74.15.191.160:41564
101.109.255.97:44351
51.255.103.170:3129
85.10.219.98:1080
117.58.241.164:52636
190.6.200.158:38256
15.165.112.193:3128
45.173.146.40:54295
190.152.71.230:54354
88.99.10.255:1080
188.40.183.188:1080
88.99.10.252:1080
125.26.99.186:34577
31.41.92.154:23500
86.34.197.6:23500
88.99.10.250:1080
144.76.214.156:1080
187.178.4.242:34125
197.216.2.14:8080
149.28.79.137:8081
47.88.16.118:3128
45.236.91.20:8880
104.45.188.43:3128
18.222.120.193:3128
80.187.140.26:8080
83.71.22.39:8080
91.67.240.45:3128
192.41.71.199:3128
128.199.214.87:3128
213.96.26.70:53018
35.223.64.197:1080
149.28.143.141:80
178.128.28.150:8080
148.217.94.54:3128
206.189.153.58:8080
183.111.227.124:9999
142.93.176.125:8080
198.255.114.82:3128
45.32.125.223:8080
70.169.145.164:48678
79.120.177.106:8080
157.245.66.51:8080
128.199.121.141:3128
44.232.52.177:8090
200.89.178.198:3128
128.199.85.7:8080
167.172.254.5:8080
209.97.138.116:8080
198.27.69.175:3128
165.22.213.55:3128
128.199.67.212:8080
188.165.16.230:3129
18.204.70.192:3128
209.97.160.177:3128
165.22.57.152:8080
132.145.89.166:3128
197.14.14.234:80
51.254.237.77:3129
94.103.95.59:3128
145.239.121.218:3129
93.174.94.80:8080
178.62.239.4:8080
138.197.32.120:3128
69.88.123.106:3128
183.111.227.92:9999
18.237.55.217:3128
94.177.170.7:8888
41.79.78.197:3128
180.243.35.6:3128
42.118.204.148:8080
125.212.218.43:8888
188.214.82.142:8080
52.166.53.92:8081
175.126.73.142:9999
200.73.128.45:8080
103.233.198.156:8081
217.61.121.57:8888
1.234.44.24:9999
195.158.30.150:8080
159.192.94.251:8213
78.160.160.236:8080
51.89.226.241:9999
207.246.95.163:8080
183.111.227.119:9999
98.158.58.200:8080
12.105.130.3:3128
107.175.247.221:8080
180.210.201.57:3130
175.126.73.138:9999
46.151.108.6:44211
185.158.248.242:5836
180.210.201.54:3128
173.82.74.62:5836
37.59.61.18:8080
52.221.211.14:80
183.89.171.151:8080
103.83.173.99:8088
118.99.99.225:8080
136.243.30.201:3128
14.207.168.13:8213
165.22.254.139:8080
46.218.155.194:3128
3.8.226.158:8088
173.249.46.92:3128
35.201.236.186:80
206.57.165.188:8080
200.219.152.226:3128
198.13.46.171:3129
69.50.64.15:3128
183.88.41.225:8080
200.73.129.158:3128
185.80.129.162:3128
188.173.32.55:8888
171.100.219.71:8080
35.175.32.97:80
186.148.169.34:9991
198.98.55.168:8080
18.237.67.131:3128
43.245.216.178:8080
173.82.177.210:5836
34.219.87.251:3128
183.89.11.236:8080
151.22.181.231:8080
51.91.212.159:3128
167.86.66.178:3128
185.169.97.224:80
173.82.74.61:5836
139.180.210.93:8080
172.87.222.6:3128
35.187.232.65:3128
149.28.36.89:3128
199.195.248.24:8080
173.82.74.59:5836
173.82.177.213:5836
183.89.152.203:8213
198.58.10.64:8080
128.199.238.247:8080
51.158.72.65:3128
176.114.209.191:8080
45.77.106.180:8080
103.78.183.142:48225
190.144.217.5:80
173.82.177.214:5836
201.49.37.133:80
181.30.28.120:8080
191.241.41.48:8080
95.141.36.112:8686
152.231.27.54:999
117.102.105.91:8080
148.101.207.121:8080
173.82.74.60:5836
201.76.163.137:8080
181.115.68.2:3128
139.180.218.225:8080
187.130.75.77:3130
217.160.65.106:3128
149.28.141.36:80
191.97.14.58:999
79.100.230.17:3128
5.39.50.81:3128
5.102.50.6:3128
173.82.177.212:5836
162.251.158.207:48275
167.249.181.246:8080
103.226.142.90:41386
204.15.243.234:40860
181.129.70.82:31017
185.189.211.70:8080
104.245.228.65:8080
50.233.228.147:8080
118.174.232.44:38093
77.252.26.71:57348
45.4.85.75:9991
175.106.17.62:45864
89.34.208.223:50478
170.238.255.90:34313
103.75.162.68:36015
82.177.38.187:8080
195.211.30.115:46127
202.93.227.14:53281
113.161.207.99:60626
124.41.243.31:30978
173.46.67.172:58517
209.190.32.28:3128
103.240.160.21:6666
176.104.52.46:47578
194.183.168.129:31385
193.200.151.69:48241
172.87.222.9:3128
178.218.104.42:32829
109.200.156.102:8080
109.199.133.161:23500
176.110.154.59:45515
208.255.161.107:3128
1.20.100.227:57396
45.162.230.84:80
103.9.188.151:38439
185.121.2.31:8080
103.26.54.94:8080
93.157.163.66:35081
103.250.153.242:31382
125.162.66.95:8080
89.38.97.228:5836
45.71.80.2:59598
5.172.2.240:56395
89.216.48.230:44061
177.47.206.3:8080
103.70.145.215:58485
79.137.123.252:3139
200.55.218.202:53281
103.50.154.4:57677
195.228.210.244:8080
118.173.233.149:45160
201.217.4.101:53281
103.94.196.30:61945
83.97.111.202:41258
202.69.38.82:8080
117.6.161.118:53281
202.9.120.179:57512
202.154.190.234:8080
176.98.76.203:36651
193.41.88.58:53281
128.199.179.30:47862
178.130.116.121:8080
193.86.229.230:8080
91.217.42.3:8080
77.238.79.111:8080
195.228.210.242:8080
159.203.82.173:3128
139.255.40.130:8080
103.9.124.210:8080
85.159.48.170:40014
46.249.123.146:8080
192.99.160.45:8080
80.94.229.172:3128
182.52.90.43:33326
88.99.10.253:1080
182.53.197.156:30082
85.10.219.102:1080
167.172.191.249:39193
103.127.189.13:808
195.4.164.127:8080
3.127.143.32:3128
3.17.41.198:3838
195.69.221.198:33972
36.79.142.126:80
85.10.219.101:1080
88.99.10.249:1080
178.128.24.20:53
202.142.158.114:8080
103.4.65.90:42493
103.87.168.226:32128
193.233.183.145:8080
5.160.151.46:23500
1.0.184.144:8080
200.37.231.66:8080
195.154.67.61:3128
73.239.197.175:8080
103.78.75.165:8080
64.17.30.238:63141
63.151.67.7:8080
167.179.4.134:8080
43.245.216.69:53281
62.210.58.175:5836
167.99.106.206:3128
200.6.185.206:8080
103.105.40.133:16538
113.130.126.212:36148
88.247.10.31:8080
205.158.57.2:53281
49.128.184.34:3128
202.142.153.181:32296
103.83.38.156:5836
45.115.174.29:38961
123.49.49.166:23500
162.252.144.229:8181
103.76.20.155:54845
179.27.83.222:57096
132.145.82.248:3128
85.185.159.98:8080
94.228.21.66:30784
195.248.243.139:8080
103.25.47.130:8080
217.160.63.219:3128
46.188.30.132:8080
186.250.56.135:8080
50.201.51.216:8080
91.192.4.169:8090
54.90.107.200:80
167.99.178.162:80
176.36.164.240:37470
58.96.148.97:8080
185.21.67.212:80
80.78.74.133:55443
134.0.63.134:8000
105.208.44.183:52841
205.185.127.8:8080
190.152.125.250:48876
177.55.207.38:8080
163.172.202.29:5836
163.172.203.183:5836
103.47.93.26:8080
104.236.55.48:8080
185.100.13.184:58422
177.75.159.8:8080
192.41.13.71:3128
161.156.69.189:3128
185.64.208.112:8080
176.62.188.158:56351
176.103.173.97:40549
177.38.68.201:8080
168.90.50.118:58192
187.115.76.17:32589
103.83.116.210:55443
177.124.184.52:8080
66.70.212.77:80
117.206.151.66:41066
163.172.206.222:5836
176.119.134.98:23500
163.172.202.64:5836
119.82.253.175:31500
181.129.86.82:999
210.1.246.82:8080
103.87.169.167:52308
140.238.15.65:3128
211.21.193.171:3128
163.172.203.163:5836
106.105.217.70:8080
62.201.238.250:8080
190.236.167.75:8080
64.227.115.85:3128
195.178.56.35:8080
195.209.176.2:8080
101.51.106.70:49285
177.37.96.219:8088
180.245.67.178:8080
200.167.191.227:9090
103.240.161.108:6666
154.127.120.18:30280
75.151.213.85:8080
92.247.93.142:60762
89.40.48.186:8080
104.148.76.143:3128
177.66.255.26:40337
118.97.235.234:8080
85.10.219.96:1080
13.233.200.22:1080
37.120.192.154:8080
85.10.219.103:1080
111.93.173.38:34707
194.44.172.254:23500
198.98.56.71:8080
91.211.172.38:8080
103.73.125.248:3129
144.76.214.157:1080
118.172.51.110:36552
103.228.117.244:8080
169.255.126.211:60129
111.118.154.20:53281
103.129.195.108:54033
103.126.218.68:8080
36.37.201.187:39498
176.241.89.170:31921
64.227.126.28:3128
85.10.198.195:3838
81.23.32.47:443
194.87.110.243:5836
45.162.230.84:8080
212.227.193.229:3128
161.38.11.86:8080
107.178.4.215:35330
173.82.119.172:5836
65.152.119.226:39408
107.190.148.202:50854
172.87.222.7:3128
140.238.19.197:3128
212.172.74.14:443
51.91.109.83:80
103.150.61.3:8080
176.119.159.237:5836
212.129.6.67:5836
212.83.188.95:5836
183.111.227.123:9999
34.77.63.53:3128
74.208.112.84:8080
165.22.59.129:3128
149.28.147.125:8080
211.21.193.171:8080
200.73.129.173:8080
82.200.181.54:3128
104.41.29.43:80
121.183.203.76:3128
191.232.53.73:80
163.172.202.67:5836
54.229.251.214:80
139.180.133.31:8080
165.22.36.75:8888
91.82.85.154:3128
110.44.133.135:3128
102.130.114.107:3128
217.160.63.18:3128
153.127.29.158:3128
51.158.123.52:3128
64.225.77.173:8080
187.115.67.11:3128
171.255.199.24:3128
174.67.106.117:80
173.82.177.227:5836
144.121.248.114:8080
217.160.75.234:3128
160.2.38.41:8080
24.172.34.114:40675
36.91.69.82:8080
65.184.156.234:33247
191.232.52.117:80
117.206.148.203:36459
192.162.62.197:59246
200.115.53.225:3128
24.172.82.94:53281
49.128.178.22:45869
89.238.255.34:8082
90.189.209.127:80
183.88.212.141:8080
104.245.69.26:3128
125.26.108.170:61637
34.220.208.37:3128
139.255.25.83:3128
41.60.238.0:8080
217.19.209.253:8080
192.41.71.221:3128
91.216.66.70:32306
80.244.239.21:8080
149.28.44.208:8080
103.83.38.155:5836
144.76.214.159:1080
186.15.233.218:45999
182.160.117.130:53281
118.174.220.133:50616
193.34.55.64:58099
91.135.148.198:59384
163.172.206.69:5836
46.39.245.204:57825
81.95.131.10:44292
181.102.184.71:7071
109.172.57.250:23500
45.79.210.241:8118
103.116.203.242:43520
177.94.225.58:61104
187.17.19.90:44985
181.209.82.154:23500
195.9.61.22:56099
205.185.116.235:8080
144.76.214.154:1080
45.235.163.35:33265
144.76.214.155:1080
144.76.214.153:1080
89.46.207.214:8080
93.78.238.94:41258
91.144.147.248:37632
5.77.7.100:30355
186.226.172.165:33345
102.164.211.175:54436
177.8.216.114:8080
85.90.215.111:3128
103.88.221.194:44507
61.19.40.50:33665
203.192.229.251:8080
78.46.81.7:1080
188.40.183.185:1080
195.138.72.84:55126
188.40.183.190:1080
188.40.183.191:1080
103.14.235.26:8080
103.42.195.70:53281
103.69.220.2:45155
88.99.10.248:1080
134.19.254.2:21231
122.50.5.146:10000
181.143.106.162:59330
117.54.238.66:8080
188.40.183.187:1080
101.109.35.119:8080
5.63.158.228:3128
188.40.183.184:1080
118.172.61.155:8080
35.223.56.145:3128
159.8.114.37:8123
203.196.32.61:45305
187.160.245.156:3128
195.234.87.211:53281
95.65.73.200:60952
190.122.186.196:8080
195.9.188.78:53281
143.255.241.96:45849
159.224.83.100:8080
80.73.90.18:3128
212.115.224.71:53281
138.97.12.150:37198
103.113.197.11:8080
88.198.33.232:1080
110.235.255.201:50813
87.197.156.62:23500
182.16.166.86:44902
41.203.240.50:3128
36.89.182.85:51387
177.46.148.142:3128
115.84.99.182:57148
194.44.225.34:53281
103.254.167.74:35594
85.198.250.135:3128
183.88.219.206:41564
202.138.127.66:80
186.159.3.193:56861
103.87.236.46:41183
195.60.174.123:41050
95.31.119.210:31135
116.254.100.165:46675
118.97.100.83:35220
91.194.42.51:80
121.167.250.146:8080
95.80.98.41:8080
103.236.114.38:49638
182.16.171.65:30679
189.57.62.146:80'''


def get_proxy(threads=100, timeout=30):
    from queue import Queue
    from random import sample
    from requests import get
    from threading import Thread
    https_proxies = raw_proxy_list.splitlines()
    https_proxies = sample(https_proxies, (proxies_to_check := len(https_proxies) + 1) - 1)
    threads = proxies_to_check if threads <= 0 else threads

    def select():
        nonlocal proxies_to_check
        for offset_multiplier in range(altdiv(proxies_to_check, threads)):
            q = Queue()

            def check(proxy):
                check_res = False

                def timeout_wrapper():
                    nonlocal check_res
                    try:
                        check_res = int(get('https://t.me', proxies={'https': proxy}).status_code)
                    except Exception as e:
                        check_res = e

                checking = Thread(target=timeout_wrapper)
                checking.start()
                checking.join(timeout)
                q.put((proxy, check_res))

            for p in (portion := https_proxies[offset_multiplier * threads:(offset_multiplier + 1) * threads]):
                Thread(target=check, args=(p if p is None else f'https://{p}',), daemon=True).start()
            lim = len(portion)
            while lim:
                if q.empty():
                    pass
                else:
                    lim -= 1
                    z = q.get()
                    if z[1] == 200:
                        return z[0]
                    print(proxies_to_check := proxies_to_check - 1, z[0])
                    q.task_done()
        return ...

    print((res := get_proxy(threads, timeout) if (selected := select()) is ... else selected))
    return {'https': res}


_proxies = get_proxy(-1)


def proxy_request(address, get_and_not_post=True, ignore_proxies=False, **kwargs):
    from time import sleep
    global _proxies
    if get_and_not_post:
        from requests import get as r
    else:
        from requests import post as r
    f = 7
    while f:
        while _proxies is None and not ignore_proxies:
            sleep(1 / 8)
        try:
            if not ignore_proxies:
                kwargs['proxies'] = _proxies
            return r(address, **kwargs)
        except Exception as e:
            _proxies = None
            _proxies = get_proxy()
            if f:
                f -= 1
            else:
                raise e
